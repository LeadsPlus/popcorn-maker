<!DOCTYPE HTML>
<html lang="en-US">
	<head>
		<meta charset="UTF-8">
		<title></title>
		<script type="text/javascript" src="../../lib/butter.js"></script>
		<script type="text/javascript" src="../shared/js/editor-state.js"></script>
		<link rel="stylesheet" type="text/css" href="../shared/css/editor.css"/>
		<style>
		
		#map {
			height: 300px;
		}
		
		</style>
	</head>
	<body>
		<table class="form">
			<tbody class="form-header">
				<tr><th colspan="2">Time</th></tr>
			</tbody>
			<tbody>
				<tr>
					<th><label for="start">From:</label></th>
					<td><input type="text" id="start"/></td>
				</tr>
				<tr>
					<th><label for="end">To:</label></th>
					<td><input type="text" id="end"/></td>
				</tr>
			</tbody>

			<tbody class="form-header">
				<tr><th colspan="2">Content</th></tr>
			</tbody>
			<tbody>
				<tr>
					<th><label for="title">Title:</label></th>
					<td><input type="text" id="title"/></td>
				</tr>
				<tr>
					<th><label for="link">Link:</label></th>
					<td><input type="text" id="link"/></td>
				</tr>
			</tbody>

			<tbody class="form-header">
				<tr><th colspan="2">Location</th></tr>
			</tbody>
			<tbody>
				<tr>
					<th><label for="address">Address:</label></th>
					<td><input type="text" id="address"/></td>
				</tr>
				<tr>
					<th><label for="lat">Latitude:</label></th>
					<td><input type="text" id="lat"/></td>
				</tr>
				<tr>
					<th><label for="lng">Longitude:</label></th>
					<td><input type="text" id="lng"/></td>
				</tr>
				<tr>
					<th><label>Map:</label></th>
					<td id="map"></td>
				</tr>
			</tbody>
<!--
			<tbody class="form-header">
				<tr><th colspan="2">Position</th></tr>
			</tbody>
			<tbody>
				<tr>
					<th><label for="left">Left (%):</label></th>
					<td><input type="text" id="left"/></td>
				</tr>
				<tr>
					<th><label for="top">Top (%):</label></th>
					<td><input type="text" id="top"/></td>
				</tr>
			</tbody>
-->
			<tbody id="target-section">
				<tr>
					<th><label for="target">Target:</label></th>
					<td><select id="target"></select></td>
				</tr>
			</tbody>
		</table>
		<div id="control-buttons">
			<input type="button" value="Undo" id="undo"/>
			<input type="button" value="Cancel" id="cancel"/>
			<input type="button" value="Delete" id="delete"/>
			<input type="button" value="OK" id="ok"/>
		</div>
		<script type="text/javascript">
		
		(function() {
			var bin, icons = [], userIcons, i, editor,
				gmaps, geocoder,
				map, latLng, marker, tempMarker,
				latLngTimeout, locationTimeout;
			
			function saveLocation(loc) {
				if (!loc) {
					return;
				}

				if (loc.latLng) {
					loc = loc.latLng;
				}

				tempMarker.setVisible(false);
				
				latLng = loc;
				
				editor.setField('lat', loc.lat());
				editor.setField('lng', loc.lng());

/*	
				marker.setPosition(loc);
				marker.setTitle(trackEvent.label);
				marker.setVisible(true);
				
				map.setCenter(loc);
*/
			}
			
			function geocode(location) {

				function processResults(results) {
					latLng = results[0].geometry.location;
					map.fitBounds(results[0].geometry.viewport);
					
					tempMarker.setPosition(latLng);
					tempMarker.setTitle(results[0].formatted_address);
					tempMarker.setVisible(true);
				}

				if (geocache[location]) {

					processResults(geocache[location]);

				} else if (geocoder) {

					geocoder.geocode( { address: location },
						function(results, status) {
							if (status == gmaps.GeocoderStatus.OK) {
								geocache[location] = results;
								processResults(results);
							}
						}
					);

				}
			}
			
			function checkLocation() {
				if (locationTimeout) {
					clearTimeout(locationTimeout);
					locationTimeout = false;
				}

				locationTimeout = setTimeout(function() {
					var loc;

					if (!geocoder) {
						return;
					}

					loc = elements.location.value;
					loc = loc.replace(/^[\s\t\n\r ]+/, '');
					loc = loc.replace(/[\s\t\n\r ]+$/, '');
					loc = loc.replace(/[\s\t\n\r ]+/, ' ', 'g');
					
					if (loc) {
						geocode(loc);
					}
				}, 500);
			}
			
			function checkLatLng(field, value) {
				if (latLngTimeout) {
					clearTimeout(latLngTimeout);
					latLngTimeout = false;
				}

				latLngTimeout = setTimeout(function() {

					var lat, lng;
					if (!geocoder) {
						return;
					}

					if ( field.id === 'lat') {
						lat = value;
						lng = editor.trackEvent.lng;
						if ( lat !== '' && isNaN(lat) || lat < -90 || lat > 90 ) {
							field.element.style.backgroundColor = '#f11';
							lat = '';
						} else {
							field.element.style.backgroundColor = '';
						}
					} else {
						lat = editor.trackEvent.lat;
						lng = value;

						if ( lng !== '' && isNaN(lng) || lng < -180 || lng > 180 ) {
							field.element.style.backgroundColor = '#f11';
							lng = '';
						} else {
							field.element.style.backgroundColor = '';
						}
					}

					if (!isNaN(lat) && !isNaN(lng) ) {
						//saveLocation( new gmaps.LatLng(lat, lng) );
						var loc = new gmaps.LatLng(lat, lng);
						tempMarker.setVisible(false);
						marker.setPosition(loc);
						marker.setTitle(editor.trackEvent.title);
						marker.setVisible(true);
						
						map.setCenter(loc);
					}
				}, 500);
			}
			
			function loadGoogleMaps() {
				var trackEvent = editor.trackEvent;

				gmaps = window.google.maps;
				geocoder = new gmaps.Geocoder();
				
				map = new gmaps.Map(document.getElementById('map'), {
					zoom: 3,
					mapTypeId: gmaps.MapTypeId.ROADMAP
				});
				
				marker = new gmaps.Marker({
					map: map,
					visible: false,
					draggable: true,
					icon: 'https://www.google.com/intl/en_ALL/mapfiles/marker_purple.png'
				});
				
				tempMarker = new gmaps.Marker({
					map: map,
					visible: false,
					draggable: true
				});
				
				gmaps.event.addListener(marker, 'dragend', saveLocation);
				gmaps.event.addListener(marker, 'click', saveLocation);
				gmaps.event.addListener(tempMarker, 'dragend', saveLocation);
				gmaps.event.addListener(tempMarker, 'click', saveLocation);

				if (trackEvent.lat !== undefined &&
					!isNaN(trackEvent.lat) &&
					trackEvent.lng !== undefined &&
					!isNaN(trackEvent.lng) &&
					trackEvent.lat < -90 && trackEvent.lat > 90 &&
					trackEvent.lng < -180 && trackEvent.lng > 180
					) {
					latLng = new gmaps.LatLng(trackEvent.lat, trackEvent.lng);
					map.setCenter(latLng);
					map.setZoom(14);

					saveLocation(latLng)

				} else if (trackEvent.location) {
					geocode(trackEvent.location);
				} else {
					latLng = new gmaps.LatLng(37.09024, -95.712891);
					map.setCenter(latLng);
				}
			}

			if (window.parent) {
				try {
					gmaps = window.parent.google && window.parent.google.maps;
				} catch (e) {
				}
			}
				
			if (gmaps) {
				loadGoogleMaps();
			} else {
				(function() {
					var script = document.createElement('script');
					script.src = 'http://maps.google.com/maps/api/js?sensor=false&callback=loadGoogleMaps';
					document.head.appendChild(script);

					window.loadGoogleMaps = loadGoogleMaps;
				}());
			}

			editor = new EditorState({
				start: {
					type: 'time'
				},
				end: {
					type: 'time'
				},
				top: {
					type: 'percent'
				},
				left: {
					type: 'percent'
				},
				title: 'text',
				address: {
					type: 'text',
					callback: function(one, two, three) {
					}
				},
				lat: {
					type: 'number',
					callback: checkLatLng
				},
				lng: {
					type: 'number',
					callback: checkLatLng
				},
				target: {
					type: 'target',
					fieldset: 'target-section'
				}
			}, 30);
			
			//main controls
			document.getElementById('undo').addEventListener('click', function(event) {
				editor.undo();
			}, false);

			document.getElementById('cancel').addEventListener('click', function(event) {
				editor.cancel();
			}, false);

			document.getElementById('ok').addEventListener('click', function(event) {
				editor.ok();
			}, false);

			document.getElementById('delete').addEventListener('click', function(event) {
				editor.del();
			}, false);

			//save expanded fieldset state in localStorage
			var headers = document.getElementsByClassName('form-header'),
				headerStates,
				header, id;
				
			try {
				headerStates = (localStorage && JSON.parse(localStorage.pmHeaderStates));
			} catch(e) {
			}
			if (!headerStates) {
				headerStates = {};
			}

			for (i = 0; i < headers.length; i++) {
				header = headers[i];
				id = header.id || EditorState.util.trim(header.textContent);
				header.addEventListener('click', (function(element, id) {
					return function() {
						element.classList.toggle('collapse');
						if (id) {
							headerStates[id] = element.classList.contains('collapse')
							try {
								localStorage.pmHeaderStates = JSON.stringify(headerStates);
							} catch (e) {
							}
						}
					};
				}(header, id)), false);
				if (id && headerStates[id]) {
					header.classList.add('collapse');
				}
			}
		}());
		</script>
	</body>
</html>
