<!DOCTYPE HTML>
<html lang="en-US">
	<head>
		<meta charset="UTF-8">
		<!-- Set your own title here -->
		<title>Popcorn.js Map</title>
		<!--
		The base tag makes all relative URLs point to Mozillas server where
		all the extra scripts and images are hosted.

		If you want to add any of your own files, either remove the base tag
		and make sure all the scripts refer to the right absolute URLs, or
		set your own references to be absolute URLs on your server. 
		-->
		<!--
		<base href="http://mozillapopcorn.org/maker/layouts/map/"/>
		-->
		<style type="text/css">
		
		body {
			color: #222;
			background-color: #aaa;
			font-family: Helvetica,Arial,sans-serif;
			font-size: 12px;
			margin: 0;
			padding: 0;
		}

		header {
			padding: 0 40px;
		}

		#main-container {
			position: relative;
			overflow: hidden;
		}

		#video-container {
			position: relative;
		}

		#video {
			width: 100%;
		}
		
		#video-container .vjs-big-play-button,
		#video-container .vjs-controls,
		#video-container .vjs-styles-check {
			z-index: 202;
		}
		
		#video-container .vjs-spinner {
			z-index: 201;
		}
		
		/* disable full screen button */
		#video-container .vjs-fullscreen-control {
			display: none;
		}
		#video-container .vjs-volume-control {
			right: 10px;
		}
		#video-container .vjs-time-control {
			right: 65px;
		}
		#video-container .vjs-progress-control {
			right: 140px;
		}

		#video-container .popcorn-words {
			z-index: 250;
		}

		#video-container video {
			display: block;
			width: 100%;
		}
		
		#video-container {
			font-size: 20px;
			line-height: normal;
		}

		#video-container > div {
			line-height: normal;
		}
		
		#pop-container > div {
			/* default position */
			position: absolute;
			top: 0;
			left: 0;
		}

		.popcorn-map {
			position: absolute;
			top: 0;
			left: 0;
			opacity: 0;
			-moz-transition: opacity 0.4s;
			-webkit-transition: opacity 0.4s;
			-o-transition: opacity 0.4s;
			-ie-transition: opacity 0.4s;
			transition: opacity 0.4s;
		}
		
		.popcorn-map.active {
			opacity: 1;
		}

		</style>
		<link rel="stylesheet" href="css/video-js.css" type="text/css" media="screen" title="Video JS">
		<script data-butter="project-data" type="application/json"></script>
	</head>
	<body>
		<header></header>
		<div style=" width: 100%">
			<div id="main-container">
				<div id="video-container" class="video-js-box" data-butter="target">
					<video id="video" preload class="video-js" data-butter="media" controls>
						<source src="http://videos-cdn.mozilla.net/serv/webmademovies/Moz_Doc_0329_GetInvolved_ST.webm" type='video/webm; codecs="vp8, vorbis"'/>
					</video>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="external/video.js"></script>
	<script type="text/javascript" src="../../lib/popcorn/popcorn.js"></script>
	<script type="text/javascript" src="../shared/js/popcorn.words.js"></script>
	<script type="text/javascript" src="../shared/js/popcorn.lightbox.js"></script>
	<script type="text/javascript" src="../shared/js/popcorn.map.js"></script>
	<script src="../../lib/butter.js"></script>
	<script>
	(function() {

		var popcorn;

		function addTrackEvent(trackEvent) {
			var options = trackEvent.popcornOptions;
			
			if (trackEvent.type === 'map') {
			}
			
			if (typeof popcorn[ trackEvent.type ] === 'function') {
				popcorn[ trackEvent.type ]( trackEvent.popcornOptions );
			}
		}
		
		function prepareVideoPlayer(video) {
			/*
			VideoJS unfortunately checks for <source> elements
			in the video to validate that it can play, which is
			a bad idea on many levels. Butter removes any <source>
			elements and sets a single src attribute.
			
			In general, we should be using a different player, but
			for now, making this work by putting the source element
			back in place.
			*/
			
			var source, src, i, re,
				types = ['webm', 'mp4', 'ogg'];
			
			if (typeof video === 'string') {
				video = document.getElementById(video);
			}
			
			if (!video) {
				return;
			}
			
			if (!video.children|| !video.children.length) {
				re = new RegExp('\\.(' + types.join('|') + ')$');
				source = document.createElement('source');
				source.setAttribute('src', video.src);
				src = re.exec(video.src);
				if (src && src.length > 1) {
					source.setAttribute('type', 'video/' + src[1]);
				}

				video.appendChild(source);

				for (i = 0; i < types.length; i++) {
					src = video.src.replace(re, '.' + types[i]);
					if (src !== video.src) {
						source = document.createElement('source');
						source.setAttribute('src', src);
						source.setAttribute('type', 'video/' + types[i]);
						video.appendChild(source);
					}
				}
			}
			
			var player = new VideoJS( video );
		}
		
		var butterMapping = [];
		var template = new Butter.Template({
			loadFromData: function( importData ) {
				var medias = importData.media;
				if ( medias ) {
					for ( var m=0; m<medias.length; ++m ) {
						var media = medias[ m ];
						popcorn = Popcorn( '#' + media.target, { frameAnimation: true } );
						prepareVideoPlayer(media.target);
						if ( media.tracks ) {
							for ( var t=0; t<media.tracks.length; ++t ) {
								var track = media.tracks[ t ];
								if ( track.trackEvents ) {
									for ( var e=0; e<track.trackEvents.length; ++e ) {
										var trackEvent = track.trackEvents[ e ];
										addTrackEvent(trackEvent);
									} //for trackEvents
								} //if trackEvents
							} //for tracks
						} //if tracks
					} //for medias
				} //if medias
			},
			onfetchhtml: function( message ) {
				return template.link.getHTML( message );
			},
			onmediaremoved: function( message ) {
				template.link.removeMedia( template.link.getMedia( message.id ) );
			},
			onmediatimeupdate: function( message ) {
				template.link.currentMedia.popcorn.currentTime( message );
			},
			onmediachanged: function( message ) {
				if ( template.link.currentMedia ) {
					template.link.currentMedia.removeHandlers( template.link.comm );
				}
				var currentMedia = template.link.currentMedia = template.link.getMedia( message.id );
				if ( currentMedia ) {
					currentMedia.addHandlers( template.link.comm, {
						'trackeventadded': function( message ) {
							var media = template.link.currentMedia;
							addTrackEvent(message);
							//media.popcorn[ message.type ]( message.popcornOptions );
							butterMapping[ message.id ] = media.popcorn.getLastTrackEventId();
						},
						'trackeventupdated': function( message ) {
							var media = template.link.currentMedia;
							if ( butterMapping[ message.id ] ) {
								media.popcorn.removeTrackEvent( butterMapping[ message.id ] );
							}
							addTrackEvent(message);
							//media.popcorn[ message.type ]( message.popcornOptions );
							butterMapping[ message.id ] = media.popcorn.getLastTrackEventId();
						},
						'trackeventremoved': function( message ) {
							var media = template.link.currentMedia;
							if ( butterMapping[ message.id ] ) {
								media.popcorn.removeTrackEvent( butterMapping[ message.id ] );
							}
						},
						'play': currentMedia.play,
						'pause': currentMedia.pause,
						'mute': currentMedia.mute
					});
				}
			},
			onmediaadded: function( message ) {
				var link = template.link;
				if ( !link.getMedia( message.id ) ) {
					var media = new Butter.TemplateMedia( message );
					link.addMedia( media );
					media.prepareMedia( media.findMediaType() );
					media.createPopcorn( media.generatePopcornString({
						options: {
							frameAnimation: true
						}
					}) );
					media.waitForPopcorn( function( p ) {
						popcorn = p;
						media.setupPopcornHandlers( link.comm );
						link.sendMedia( media );
					});

					prepareVideoPlayer( media.target );
				}
			},
			onsetup: function( options ) {
				template.link.scrape();
			}
		});

	})();
	</script>
</html>
